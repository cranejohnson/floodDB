
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://www.weather.gov/source/aprfc/js/jquery.ui.slider.custom.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
 <script src="https://www.weather.gov/source/aprfc/js/moment.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<link rel="stylesheet" href="http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.css"/>
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.4/dist/MarkerCluster.css"/>
<script src="https://unpkg.com/leaflet.icon.glyph@latest"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.4/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="http://azavea.github.io/Leaflet.zoomdisplay/css/leaflet.zoomdisplay.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.0.4/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/esri-leaflet@2.0.8"></script>
<script src="http://azavea.github.io/Leaflet.zoomdisplay/js/leaflet.zoomdisplay.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.3/proj4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.1/proj4leaflet.min.js"></script>
<script src="http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.min.js"></script>
<script src="https://www.weather.gov/source/aprfc/js/esri2geojson.js"></script>




<style>

.box-table-a {
    font-family:"Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
    font-size:12px;
    width:100%;
    text-align:left;
    border-collapse:collapse;
    margin:0px;}

.box-table-a th{
    font-size:13px;
    font-weight:normal;
    background:#b9c9fe;
    border-top:4px solid #aabcfe;
    border-bottom:1px solid #fff;
    color:#039;
    padding:8px;}

.box-table-a td{
    background:#e8edff;
    border-bottom:1px solid #fff;
    color:#669;
    border-top:1px solid transparent;
    padding:8px;}

.box-table-a tr:hover td{
    background:#d0dafd;
    color:#339;}

h4 {
    text-align: center;
}

.center{
    text-align: center;
}

.maincontainer {
    width: 80%;
    background: grey;
    margin: auto;
    padding: 10px;
}
#containerNFIP {
    width: 50%;
    height: 400px;
    background: red;
    float: left;
}
#containerBorough {
    margin-left: 50%;
    height: 400px;
    background: black;
}

.map {
    height: 300px;
    width: 400px;
}

#mapid {
    height   : 500px;
    width    : 100%;
    margin   : 0px;
    padding  : 0px;
    overflow : hidden;
},

#qmeas-years{
    text-align: center;
    width: 400;
    margin: auto;
}

#qmeas-months{
    text-align: center;
    width: 400;
    margin: auto;
}

#siteInfo{
    text-align: left;
    background-color: lightgray;
}

.ui-slider .ui-slider-handle{
        width:10px;

}

/* Tooltip container */
.tooltip {
    position: relative;
    display: inline-block;
    border-bottom: 1px dotted black; /* If you want dots under the hoverable text */
}

/* Tooltip text */
.tooltip .tooltiptext {
    visibility: hidden;
    width: 800px;
    background-color: black;
    color: #fff;
    text-align: center;
    padding: 5px 0;
    border-radius: 6px;

    /* Position the tooltip text - see examples below! */
    position: absolute;
    top:40px;
    right: 105%;
    z-index: 1;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
    visibility: visible;
}

</style>
<script>

//import {geojsonToArcGIS, arcgisToGeoJSON} from 'esri2geojson.js';


var communities = {};

var floods = {};
var plotFloods = {};
var layersByName = {};
var DCI = {};
var hmp = {};
var roads = {};
var map = {};
var geoMilePost = {
        "type" : "FeatureCollection",
        'crs': {
            'type': 'name',
            'properties': {
                'name': 'EPSG:3857'
            }
        },
        "features": []
    };

var geoFloods = {
        "type" : "FeatureCollection",
        'crs': {
            'type': 'name',
            'properties': {
                'name': 'EPSG:3857'
            }
        },
        "features": []
    };

$( function() {


    $( "#qmeas-years" ).dragslider({
        range: true,
        min: 1889,
        max: 2017,
        rangeDrag: true, // Enable range dragging.
        step: 1,
        values: [1889,2017],
        slide: function( event, ui ) {
            $( "#years2show" ).val(ui.values[0]+ " - " +ui.values[1]);
            mapFloods(geoFloods);
        },
        stop: function( event, ui ) {
            $( "#years2show" ).val(ui.values[0]+ " - " +ui.values[1]);
            mapFloods(geoFloods);
        }
    });

    $( "#qmeas-months" ).dragslider({
        range: true,
        min: 0,
        max: 11,
        step: 1,
        rangeDrag: true, // Enable range dragging.
        values: [0,11],
        slide: function( event, ui ) {
            $( "#months2show" ).val( moment(new Date(2012, ui.values[0], 01)).format("MMM")+ " - " + moment(new Date(2012, ui.values[1], 01)).format("MMM") );
            mapFloods(geoFloods);
        },
        stop: function( event, ui ) {
            $( "#months2show" ).val( moment(new Date(2012, ui.values[0], 01)).format("MMM")+ " - " + moment(new Date(2012, ui.values[1], 01)).format("MMM") );
            mapFloods(geoFloods);
        }
    });


    $("#singleYear").blur(function() {
        if($( "#singleYear" ).val().length ==4){
            $( "#years2show" ).val($("#singleYear").val()+ " - " +$("#singleYear").val());
            $( "#qmeas-years" ).dragslider('values',0,$("#singleYear").val());
            $( "#qmeas-years" ).dragslider('values',1,$("#singleYear").val());
            mapFloods(geoFloods);
        }
    });
});



$(document).ready(function(){
    $("input[type='checkbox']").on('change', function(){
         mapFloods(geoFloods);
    });

    $(document).keydown(function(e) {
        if($( "#singleYear" ).val().length ==4){
            if(e.keyCode == 39){
                var newYear = parseInt($( "#singleYear" ).val())+1;
                $( "#singleYear" ).val(newYear);
            }
            if(e.keyCode == 37){
                var newYear = parseInt($( "#singleYear" ).val())-1;
                $( "#singleYear" ).val(newYear);
            }
            $( "#years2show" ).val($("#singleYear").val()+ " - " +$("#singleYear").val());
            $( "#qmeas-years" ).dragslider('values',0,$("#singleYear").val());
            $( "#qmeas-years" ).dragslider('values',1,$("#singleYear").val());
            mapFloods(geoFloods);
        }
    });
});

//////////////////////////Mapping Code//////////////////////////

function findStreamByName(name,map){

    $('#loading-image').show();
    //var bounds = map.getBounds();
    var corner1 = L.latLng(50, -170),
        corner2 = L.latLng(75, -132),
        bounds = L.latLngBounds(corner1, corner2);

    var nhdUrl = 'https://services.nationalmap.gov/arcgis/rest/services/nhd/mapserver/9/query';
    var streamURL = 'https://txpub.usgs.gov/arcgis/rest/services/Streamer/HydroData/MapServer/1/query';
    var params = {
        //where: 'upper(GNIS_NAME) like upper(\'%'+name+'%\')',
        where: 'upper(Name) like upper(\'%'+name+'%\')',
        geometry:'esriGeometryEnvelope&geometry='+bounds.getEast()+','+bounds.getSouth()+','+bounds.getWest()+','+bounds.getNorth(),
        geometryType:'esriGeometryEnvelope',
        inSR:4326,
        spatialRel:'esriSpatialRelIntersects',
        returnGeometry:true,
        returnTrueCurves:false,
        geometryPrecision:1,
        outSR:3857,
        returnIdsOnly:false,
        returnCountOnly:true,
        returnZ:false,
        returnM:false,
        returnDistinctValues:false,
        //f:'geojson'
        f:'json'
        }

    $.ajax({
        type: "GET",
        url: streamURL,
        data: params,
        dataType: "json",
        success: function (data) {
            $('#foundRivers').html(' Reaches Found:'+data.count);
        }
    });

    params.returnCountOnly = false;
    var flowLines = {"type":"FeatureCollection",
                        "features":[],
                        "crs":{
                            "type": "name",
                            "properties": {
                                "name": "EPSG:3857"
                            }
                        }
                    }

    var myStyle = {
        "color": "green",
        "weight": 5,
    };
    if(typeof(layersByName['streamNameLayer'] ) != 'undefined'){
        map.removeLayer(layersByName['streamNameLayer']);
        mapControl.removeLayer(layersByName['streamNameLayer']);
    }
     $.ajax({
            type: "GET",
            url: streamURL,
            data: params,
            dataType: "json",
            success: function (data) {

                $.each(data.features,function(){
                    var geoJSON = arcgisToGeoJSON(this);
                    flowLines.features.push(geoJSON);
                });
                var markers = L.Proj.geoJson(flowLines, {
                    style: myStyle,
                    onEachFeature: function (feature, layer) {
                        var popupcontent = "";
                        $.each(feature.properties,function(k,v){
                            popupcontent = popupcontent + "<span style='font-weight:bold'>"+k+": </span>"+v+"<br>";
                        });
                        layer.bindPopup(popupcontent);

                        }
                });
                //console.log(markers.getBounds());
                map.addLayer(markers);
                layersByName['streamNameLayer'] = markers;
                var group = new L.featureGroup(markers);
                console.log(group.getBounds());

                var layers = markers.getLayers();
                //layers[0].openPopup();
                map.fitBounds(markers.getBounds());
                mapControl.addOverlay(markers, "Named Stream Reaches");

            },
            error: function (request, status, errorThrown) {
                console.log(status);
            },
            complete: function(){
                $('#loading-image').hide();
            }
        });
}

function streamer(lat,lon){

    var dest = new proj4.Proj('EPSG:3857');
    var point = proj4(dest,[lon,lat]);


    var ht = 315*100;     //imageDisplay x 100 = each pixel 100 meters
    var wd = 1370*100;    //imageDisplay x 100 = each pixel 100 meters

    var params = {
        tolerance : 20,
        returnGeometry : true,
        geometryType : 'esriGeometryPoint',
        mapExtent : (point[0]-wd)+','+(point[1]-ht)+','+(point[0]+wd)+','+(point[1]+ht),
        imageDisplay : '1370,315,1',
        f : 'json',
        sr : 102100,
        layers: 'all:1',
        //layers: 'all:15',
        geometry: '{ "x" : '+point[0]+', "y" : '+point[1]+' }'
    };
    console.log('Getting streamer');
    var flowLines = {"type":"FeatureCollection",
                        "features":[],
                        "crs":{
                            "type": "name",
                            "properties": {
                                "name": "EPSG:3857"
                            }
                        }
                    }
    var myStyle = {
        "color": "#00008B",
        "weight": 5,
        "opacity": 0.65
    };
    if(typeof(layersByName['reachLayer'] ) != 'undefined'){
        map.removeLayer(layersByName['reachLayer']);
    }
     $.ajax({
            type: "GET",
            //url: "https://services.nationalmap.gov/arcgis/rest/services/nhd/mapserver/identify",
            url: "https://txpub.usgs.gov/arcgis/rest/services/Streamer/HydroData/MapServer/identify",
            data: params,
            contentType: "application/json; charset=utf-8",
            headers : {'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'},
            dataType: "json",
            success: function (data) {
                console.log(data);
                console.log('converting');
                $.each(data.results,function(){
                    var geoJSON = arcgisToGeoJSON(this);
                    flowLines.features.push(geoJSON);
                });

            var markers = L.Proj.geoJson(flowLines, {
                style: myStyle,
                onEachFeature: function (feature, layer) {
                    var popupcontent = "";
                    $.each(feature.properties,function(k,v){
                        popupcontent = popupcontent + "<span style='font-weight:bold'>"+k+": </span>"+v+"<br>";
                    });
                    layer.bindPopup(popupcontent);

                }
            });
            map.addLayer(markers);
            layersByName['reachLayer'] = markers;


            var layers = markers.getLayers();
            layers[0].openPopup()
            //mapControl.addOverlay(markers, "Local Flow Lines");
            },
            error: function (request, status, errorThrown) {
                console.log(status);
            }
        });

}


function getHUC(lat,lon){

    var dest = new proj4.Proj('EPSG:3857');
    var point = proj4(dest,[lon,lat]);


    var ht = 315*100;     //imageDisplay x 100 = each pixel 100 meters
    var wd = 1370*100;    //imageDisplay x 100 = each pixel 100 meters

    var params = {
        tolerance : 0,
        returnGeometry : false,
        geometryType : 'esriGeometryPoint',
        //async:false,
        mapExtent : (point[0]-wd)+','+(point[1]-ht)+','+(point[0]+wd)+','+(point[1]+ht),
        imageDisplay : '1370,315,1',
        f : 'json',
        sr : 102100,
        layers: 'all:5,6',
        geometry: '{ "x" : '+point[0]+', "y" : '+point[1]+' }'
    };

    $('#siteInfo').append('Loading HUC codes.......');
     $.ajax({
            type: "GET",
            url: "https://services.nationalmap.gov/arcgis/rest/services/nhd/mapserver/identify",
            data: params,
            contentType: "application/json; charset=utf-8",
            headers : {'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'},
            dataType: "json",
            success: function (data) {
                $('#siteInfo').empty();

                $('#siteInfo').append('Lat: '+lat+'<br>Lon: '+lon+'<br>');
                $.each(data.results,function(){
                    var huc = this.layerId*2;
                    $('#siteInfo').append(this.layerName+': '+this.value+' '+this.attributes['HUC'+huc]+'<br>');
                });
                },
                error: function (request, status, errorThrown) {
                    console.log(status);
                }
        });

}



function onEachFeature(feature, layer) {
		var popupContent = "<p>I started out as a GeoJSON " +
				feature.geometry.type + ", but now I'm a Leaflet vector!</p>";
		layer.bindPopup(popupContent);
	}


function mapFloods(gFloods){

    var beginYear = $("#qmeas-years").dragslider("values",0);
    var endYear = $("#qmeas-years").dragslider("values",1);
    var beginMonth = $("#qmeas-months").dragslider("values",0);
    var endMonth = $("#qmeas-months").dragslider("values",1);

    var months = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

    var checkMonths = months.slice(parseInt(beginMonth),parseInt(endMonth)+1);
    if($('#undefMonth').is(":checked")){
        checkMonths.push('');
     }

    var floodSeverity = [];
    $.each($("input[name='severity[]']:checked"), function() {
        floodSeverity.push($(this).val());
    });

    var floodCause = [];
    $.each($("input[name='cause[]']:checked"), function() {
        floodCause.push($(this).val());
    });

    var types = [];
    $.each($("input[name='type[]']:checked"), function() {
        types.push($(this).val());
    });


    if(typeof(layersByName['floodLayer'] ) != 'undefined'){
        map.removeLayer(layersByName['floodLayer']);
        mapControl.removeLayer(layersByName['floodLayer']);
    }

    var listPlotFloods = [];
    plotFloods = {};
    plotFloods = $.extend(true, {}, gFloods);
    var matchFeatures = [];
    $.each(gFloods.features,function(i,flood){
        if(typeof(flood) != 'undefined'){
            if($.inArray(flood.properties.fldCause,floodCause)>-1){
                if($.inArray(flood.properties.floodSeverity,floodSeverity)>-1){
                    if((flood.properties.year>=beginYear)&&(flood.properties.year <= endYear)){
                        if(jQuery.inArray(flood.properties.month.trim().toLowerCase(),checkMonths) > -1){
                            if(types.length >0){
                                $.each(types,function(i,type){
                                    //console.log(flood.properties[type]);
                                    if(flood.properties[type] != ""){
                                        if($.inArray(flood.properties.floodsID,listPlotFloods) == -1){
                                            matchFeatures.push(flood);
                                            listPlotFloods.push(flood.properties.floodsID);
                                        }
                                    }
                                });
                            }
                            else{
                                matchFeatures.push(flood);
                            }
                        }
                    }
                }
            }
        }
    });

    plotFloods.features = matchFeatures;

    $('#numberPlotted').text('Events Mapped: '+plotFloods.features.length);


    var markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        maxClusterRadius: 1
    });

    var geoJsonLayer = L.geoJSON(plotFloods, {
        style: function (feature) {
            return {color: 'red'};
        },
		onEachFeature: function (feature, layer) {
              //layer.bindPopup(feature.properties.name);
              layer.on({
                click:markerClick
               });
          },
        pointToLayer: function(feature, latlng) {
        return L.marker(latlng, {
            icon: L.icon.glyph({
                prefix: '',
                glyph: feature.properties.floodsID
            })
        })
      }
	});


	markers.addLayer(geoJsonLayer);
	layersByName['floodLayer'] = markers;
    map.addLayer(markers);
    mapControl.addOverlay(markers, "Flood Events");
}

function markerClick(e) {
    var floodList = [];

    $.each(plotFloods.features,function(i,flood){
        if(flood.properties.communitiesID == e.target.feature.properties.communitiesID){
            floodList.push(flood.properties.floodsID);
        }
    });
    makeFloodTable('floodMapTable',floods,floodList);
    getHUC(e.latlng.lat,e.latlng.lng);
}


function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}


var checkCode = getParameterByName('id');
var host = location.host;

//Get DCI Table
var async1 = $.ajax({
    url:"https://script.google.com/macros/s/AKfycbwsM9SsNclK-2b3KsEqVjGZ4C3vtPByEA2SRaaWkL5EIXBR9Icr/exec?id=1b7cEPfb8wYtCUnx1JWsNRd29GCRzwzFeQCYngm-LnY4&sheet=DCI",
    dataType: "json",
    success: function( response ) {
        $.each(response,function(i,flood){
            DCI[flood.stateDR] = {
                title:flood.title,
                narrative:flood.narrative
            }
        });

    }
});

//Get Community Table
var async2 = $.ajax({
    url:"https://script.google.com/macros/s/AKfycbwsM9SsNclK-2b3KsEqVjGZ4C3vtPByEA2SRaaWkL5EIXBR9Icr/exec?id=1b7cEPfb8wYtCUnx1JWsNRd29GCRzwzFeQCYngm-LnY4&sheet=communities",
    dataType: "json",
    success: function( response ) {
        communities = response;
    }
});

//Get Flood Table
var async3 = $.ajax({
    url:"https://script.google.com/macros/s/AKfycbwsM9SsNclK-2b3KsEqVjGZ4C3vtPByEA2SRaaWkL5EIXBR9Icr/exec?id=1b7cEPfb8wYtCUnx1JWsNRd29GCRzwzFeQCYngm-LnY4&sheet=floods",
    dataType: "json",
    success: function( response ) {
        floods = response;
    }
});

//Get hmp Table
var async4 = $.ajax({
    url:"https://script.google.com/macros/s/AKfycbwsM9SsNclK-2b3KsEqVjGZ4C3vtPByEA2SRaaWkL5EIXBR9Icr/exec?id=1b7cEPfb8wYtCUnx1JWsNRd29GCRzwzFeQCYngm-LnY4&sheet=hazardMitigationPlans",
    dataType: "json",
    success: function( response ) {
        hmp = response;
    }
});

//Get road Table
var async5 = $.ajax({
    url:"https://script.google.com/macros/s/AKfycbwsM9SsNclK-2b3KsEqVjGZ4C3vtPByEA2SRaaWkL5EIXBR9Icr/exec?id=1b7cEPfb8wYtCUnx1JWsNRd29GCRzwzFeQCYngm-LnY4&sheet=AKroads",
    dataType: "json",
    success: function( response ) {
        roads = response;
        $.each(roads,function(i,road){
            var feature = {
                "type" : "Feature",
                "geometry": {},
                "properties": road
            }
            feature.geometry.coordinates = [road.LON,road.LAT];
            feature.geometry.type = "Point";
            geoMilePost.features.push(feature);
        });
        // Point style
        var mpStyle = {
            opacity: 0.9,
            radius: 1,
            fillOpacity: 0.7
        };
    }
});

function onEachFeature(feature, layer) {
    layer.bindPopup(feature.properties.ROUTE_NAME+"<br>MP: " + feature.properties.MP);
    if((feature.properties.MP % 10) == 0){
        layer.bindTooltip(feature.properties.MP.toString(),
            {
                permanent: true,
             });
    }
    layer.on('mouseover', function() { layer.openPopup(); });
    layer.on('mouseout', function() { layer.closePopup(); });

        var overlay = L.geoJson(geoMilePost, { // Make the layer from the JSON and grab the handle.
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, mpStyle);
                },
                onEachFeature: onEachFeature
            });
        //overlay.addTo(map); // Add the data to the map, now you can see the point layer.
        mapControl.addOverlay(overlay, "Mileposts");

};


function isNumeric(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}

$('#loading-image').bind('ajaxStart', function(){
    $(this).show();
}).bind('ajaxStop', function(){
    $(this).hide();
});


$.when(async1, async2,async3,async4,async5).done(function() {

    $('#loading-image').hide();
    $( "#years2show" ).val('1890 - 2017');
    $( "#months2show" ).val('Jan - Dec');
    console.log('Done Loading');
    calcNFIP(communities);


    $.each(floods,function(i,flood){
        var feature = {
            "type" : "Feature",
            "geometry": {},
            "properties": flood
        }
        var placeID = flood['communitiesID'];
        var result = communities.filter(function( obj ) {
                return obj.ID == placeID;
            });
        jQuery.extend(floods[i], result[0]);
        feature.geometry.type = "Point";
        if(feature.properties.communitiesID == ""){
            if(feature.properties.road != ""){
                $.each(roads,function(i,road){
                    if((road.ROUTE_NAME == feature.properties.road) && (road.MP == feature.properties.milePost)){
                        feature.geometry.coordinates = [road.LON,road.LAT];
                        return true;
                     }
                });
            }
        }
        else{
            feature.geometry.coordinates = [feature.properties.Lon,feature.properties.Lat];
        }
        if(feature.properties.floodSeverity == "") feature.properties.floodSeverity = 'Undefined';
        if(feature.properties.fldCause == "") feature.properties.fldCause = 'undefined';
        if(typeof(feature.geometry.coordinates) != 'undefined'){
            geoFloods.features.push(feature);

        }
        else{
            //console.log(feature);
        }

    });
    calcBorFloods(floods,10,'Major');
    calcComFloods(floods,40,'Major');
    calcCauseFloods(floods,'Total');
    calcSourceFloods(floods);
    calcFloodsByDecade(floods);
    mapFloods(geoFloods);


});

function getFloodList(floods,severity,filter,value){
    var floodList = [];
    if(value == 'Undefined');
    $.each(floods,function(i,flood){
        if((flood['floodSeverity'] == severity) &&(flood[filter] == value)){
            floodList.push(flood['floodsID']);
        }
    });
    return floodList;
}



// Builds the HTML Table out of myList.
function buildHtmlTable(selector,myList) {
  var columns = addAllColumnHeaders(myList, selector);

  for (var i = 0; i < myList.length; i++) {
    var row$ = $('<tr/>');
    for (var colIndex = 0; colIndex < columns.length; colIndex++) {
      var cellValue = myList[i][columns[colIndex]];
      if (cellValue == null) cellValue = "";
      row$.append($('<td/>').html(cellValue));
    }
    $(selector).append(row$);
  }
}

// Adds a header row to the table and returns the set of columns.
// Need to do union of keys from all records as some records may not contain
// all records.
function addAllColumnHeaders(myList, selector) {
    var columnSet = [];
    var headerTr$ = $('<tr/>');

    for (var i = 0; i < myList.length; i++) {
        var rowHash = myList[i];
        for (var key in rowHash) {
            if ($.inArray(key, columnSet) == -1) {
                columnSet.push(key);
                headerTr$.append($('<th/>').html(key));
            }
        }
    }
  $(selector).append(headerTr$);

  return columnSet;
}



function makeFloodTable(id,floods,floodList){
    var columns = ['floodsID','name','year','month','fldCause','floodSeverity','impactsHMP','impactsRiverNotes','impactsStormReports','fedDR','stateDR','stormReportID'];
    var data = [];
    $.each(geoFloods.features,function(i,flood){
        if(floodList.indexOf(flood.properties.floodsID)>-1){
            var d = {};
            var googleRow = parseInt(flood.properties.floodsRow);
            $.each(columns,function(i,val){
                d[val] = flood.properties[val];
                if(val == 'name'){
                    if(d[val] == ""){
                        d[val] = flood.properties.road+" MP "+flood.properties.milePost;
                    }
                }
                if(val == 'floodsID'){
                    d[val] = "<a target='dbTab' href='https://docs.google.com/spreadsheets/d/1b7cEPfb8wYtCUnx1JWsNRd29GCRzwzFeQCYngm-LnY4/edit#gid=1059416862&range=b"+googleRow+"'>"+d[val]+"</a>";
                }
                if(val == 'stormReportID'){
                    d[val] = "<a target='_blank' href='https://www.ncdc.noaa.gov/stormevents/eventdetails.jsp?id="+d[val]+"'>"+d[val]+"</a>";
                }
                if(val == 'fedDR'){
                    var fedNum = d[val].replace( /\D+/g, '');
                    d[val] = "<a target='_blank' href='https://www.fema.gov/disaster/"+fedNum+"'>"+d[val]+"</a>";
                }
                if(val == 'impactsHMP'){
                    hmpObj(flood,hmp);
                    if(d[val] != "") d[val] = d[val] + "<br>" + hmpObj.htmlList;
                }
                if(val == 'stateDR'){
                    if(d[val] != ""){
                       var stateDR = d[val];
                       d[val] = '<div class="tooltip">'+stateDR+'<span class="tooltiptext">'+DCI[stateDR].title+'<br>'+DCI[stateDR].narrative+'</span></div>';
                    }

                }

            });
            data.push(d);
        }
    });
    buildHtmlTable('#'+id,data);
    $('.buttonControl').html("<button type=\"button\" id=\"uncheckCause\" onclick =\"$('.dataTable').empty();\">Clear Data Tables</button>");




}

function hmpObj(flood,hmpList){

    var localList = hmpList.filter(function( obj ) {
                return obj.communityID == flood.properties.communitiesID;
            });
    var regionList = hmpList.filter(function( obj ) {
                return obj.community == flood.properties.Bor_Cen_Ar__;
            });
    var html = "";
    $.each(localList,function(i,localPlan){
        html = html + "<a target='_blank' href='"+localPlan.url+"' title='"+localPlan.planName+"("+localPlan.planYear+")'>Local - "+localPlan.planYear+"</a><br>";
    });
    $.each(regionList,function(i,plan){
        html = html + "<a target='_blank'  href='"+plan.url+"' title='"+plan.planName+"( "+plan.planYear+" )'>Regional - "+plan.planYear+"</a><br>";
    });
    hmpObj.htmlList = html;
}

function calcSourceFloods(floods){
    var sources = ['impactsHMP','impactsRiverNotes','impactsStormReports'];
    var labels = ['Hazard Mitigation Plans','River Notes','Storm Reports'];

    var zeroData = [];
    for(i=0;i<sources.length;i++){
        zeroData.push(0);
    }

    var dataArray = {};
    $.each(sources,function(i,source){
        dataArray[source] = {   Total : 0,
                                Major: 0,
                                Moderate: 0,
                                Minor: 0,
                                "Undefined":0
                                    };
    });


    $.each(floods, function(i,flood){
        $.each(sources,function(i,source){
            if(flood[source] != ""){
                dataArray[source][flood['floodSeverity']] = dataArray[source][flood['floodSeverity']] + 1;
                dataArray[source]['Total'] = dataArray[source]['Total'] + 1;
            }
        });
    });


    var floodData =
        [{
            name: 'Undefined',
            data: [],
            color: "#cccccc"
        }, {
            name: 'Minor',
            data: [],
            color: '#FFC575'
        }, {
            name: 'Moderate',
            data: [],
            color: '#FF7171'
        },{
            name: 'Major',
            data: [],
            color: '#E68EFD'
        }];


    var num = Object.keys(dataArray).length;
    var Total = 0;
    $.each(dataArray,function(i,source){
        floodData[1]['data'].push(source['Minor']);
        floodData[2]['data'].push(source['Moderate']);
        floodData[3]['data'].push(source['Major']);
        floodData[0]['data'].push(source["Undefined"]);
    });


    var chart = $('#containerSource').highcharts();

    chart.setTitle({text: "Flooding Data Sources"});
    chart.xAxis[0].setCategories(labels);
    $.each(floodData,function(i,obj){
        chart.addSeries(obj);
    });

}

function calcFloodsByDecade(floods){
    var dataArray = {};
    var borArray = {};
    $.each(floods, function(i,flood){
        var year = 1800;

        if(flood['year'] > 1900){
            year = Math.floor((flood['year']/10))*10;
        }
        if(typeof(dataArray[year]) == 'undefined'){
            dataArray[year] = { Total : 1,
                                                 Major: 0,
                                                 Moderate: 0,
                                                 Minor: 0,
                                                 Undefined:0
                                               };
            dataArray[year][flood['floodSeverity']] = 1;
        }
        else{
            dataArray[year][flood['floodSeverity']] = dataArray[year][flood['floodSeverity']] + 1;
            dataArray[year]['Total'] = dataArray[year]['Total'] + 1;
        }
    });

    var sortable = [];
    for (var year in dataArray)
        sortable.push([year, dataArray[year]]);

    sortable.sort(function(a, b) {
        return parseInt(a[0]) - parseInt(b[0]);
    })


    var labels = [];
    var floodData =
        [{
            name: 'Undefined',
            data: [],
            color: "#cccccc"
        }, {
            name: 'Minor',
            data: [],
            color: '#FFC575'
        }, {
            name: 'Moderate',
            data: [],
            color: '#FF7171'
        },{
            name: 'Major',
            data: [],
            color: '#E68EFD'
        }];

    var num = sortable.length;
    var Total = 0;
    for(i=0;i<num;i++){
        labels.push(sortable[i][0]);

        floodData[1]['data'].push(sortable[i][1]['Minor']);
        floodData[2]['data'].push(sortable[i][1]['Moderate']);
        floodData[3]['data'].push(sortable[i][1]['Major']);
        floodData[0]['data'].push(sortable[i][1]["Undefined"]);
    }

    var chart = $('#containerByDecade').highcharts();

    chart.xAxis[0].setCategories(labels);
    $.each(floodData,function(i,obj){
        chart.addSeries(obj);
    });

}


function calcCauseFloods(floods,sortby){
    var dataArray = {};
    var borArray = {};
    $.each(floods, function(i,flood){
        if(typeof(dataArray[flood['fldCause']]) == 'undefined'){
            dataArray[flood['fldCause']] = { Total : 1,
                                                 Major: 0,
                                                 Moderate: 0,
                                                 Minor: 0,
                                                 Undefined:0
                                               };
            dataArray[flood['fldCause']][flood['floodSeverity']] = 1;
        }
        else{
            dataArray[flood['fldCause']][flood['floodSeverity']] = dataArray[flood['fldCause']][flood['floodSeverity']] + 1;
            dataArray[flood['fldCause']]['Total'] = dataArray[flood['fldCause']]['Total'] + 1;
        }
    });

    var sortable = [];
    for (var site in dataArray)
        sortable.push([site, dataArray[site]]);

    sortable.sort(function(a, b) {
        return b[1][sortby] - a[1][sortby]
    })
    $.each(sortable,function(i,array){
        if(array[0] == "") array[0] = "Undefined";
    });

    var labels = [];
    var floodData =
        [{
            name: 'Undefined',
            data: [],
            color: "#cccccc"
        }, {
            name: 'Minor',
            data: [],
            color: '#FFC575'
        }, {
            name: 'Moderate',
            data: [],
            color: '#FF7171'
        },{
            name: 'Major',
            data: [],
            color: '#E68EFD'
        }];

    var num = sortable.length;
    var Total = 0;
    for(i=0;i<num;i++){
        labels.push(sortable[i][0]);
        Total = Total + sortable[i][1]['Total']
        floodData[1]['data'].push(sortable[i][1]['Minor']);
        floodData[2]['data'].push(sortable[i][1]['Moderate']);
        floodData[3]['data'].push(sortable[i][1]['Major']);
        floodData[0]['data'].push(sortable[i][1]['Undefined']);
    }

    var chart = $('#containerCauses').highcharts();
    chart.setTitle({text: "Flooding Causes ("+Total+" Floods)"});
    chart.xAxis[0].setCategories(labels);
    $.each(floodData,function(i,obj){
        chart.addSeries(obj);
    });

}

function calcBorFloods(floods,num,sortby){
    var dataArray = {};
    var borArray = {};
    $.each(floods, function(i,flood){
        if(typeof(dataArray[flood['Bor_Cen_Ar__']]) == 'undefined'){
            dataArray[flood['Bor_Cen_Ar__']] = { Total : 1,
                                                 Major: 0,
                                                 Moderate: 0,
                                                 Minor: 0,
                                                 Undefined:0
                                               };
            dataArray[flood['Bor_Cen_Ar__']][flood['floodSeverity']] = 1;
        }
        else{
            dataArray[flood['Bor_Cen_Ar__']][flood['floodSeverity']] = dataArray[flood['Bor_Cen_Ar__']][flood['floodSeverity']] + 1;
            dataArray[flood['Bor_Cen_Ar__']]['Total'] = dataArray[flood['Bor_Cen_Ar__']]['Total'] + 1;
        }
    });

    var sortable = [];
    for (var site in dataArray)
        sortable.push([site, dataArray[site]]);

    sortable.sort(function(a, b) {
        return b[1][sortby] - a[1][sortby]
    })
    var labels = [];
    var floodData =
        [{
            name: 'Undefined',
            data: [],
            color: "#cccccc"
        }, {
            name: 'Minor',
            data: [],
            color: '#FFC575'
        }, {
            name: 'Moderate',
            data: [],
            color: '#FF7171'
        },{
            name: 'Major',
            data: [],
            color: '#E68EFD'
        }];

    for(i=0;i<num;i++){
        labels.push(sortable[i][0]);
        floodData[1]['data'].push(sortable[i][1]['Minor']);
        floodData[2]['data'].push(sortable[i][1]['Moderate']);
        floodData[3]['data'].push(sortable[i][1]['Major']);
        floodData[0]['data'].push(sortable[i][1]['Undefined']);
    }

    var chart = $('#containerBorough').highcharts();

    chart.setTitle({text: "Top "+num+" Boroughs/Census Areas"});
    chart.xAxis[0].setCategories(labels);
    $.each(floodData,function(i,obj){
        chart.addSeries(obj);
    });

}

function calcComFloods(floods,num,sortby){
    var dataArray = {};
    var borArray = {};
    $.each(floods, function(i,flood){
        if(typeof(dataArray[flood['name']]) == 'undefined'){
            dataArray[flood['name']] = { Total : 1,
                                                 Major: 0,
                                                 Moderate: 0,
                                                 Minor: 0,
                                                 Undefined:0
                                               };
            dataArray[flood['name']][flood['floodSeverity']] = 1;
        }
        else{
            dataArray[flood['name']][flood['floodSeverity']] = dataArray[flood['name']][flood['floodSeverity']] + 1;
            dataArray[flood['name']]['Total'] = dataArray[flood['name']]['Total'] + 1;
        }
    });

    var sortable = [];
    for (var site in dataArray)
        sortable.push([site, dataArray[site]]);

    sortable.sort(function(a, b) {
        return b[1][sortby] - a[1][sortby]
    })
    var labels = [];
    var floodData =
        [{
            name: 'Undefined',
            data: [],
            color: "#cccccc"
        }, {
            name: 'Minor',
            data: [],
            color: '#FFC575'
        }, {
            name: 'Moderate',
            data: [],
            color: '#FF7171'
        },{
            name: 'Major',
            data: [],
            color: '#E68EFD'
        }];

    for(i=0;i<num;i++){
        labels.push(sortable[i][0]);
        floodData[1]['data'].push(sortable[i][1]['Minor']);
        floodData[2]['data'].push(sortable[i][1]['Moderate']);
        floodData[3]['data'].push(sortable[i][1]['Major']);
        floodData[0]['data'].push(sortable[i][1]['Undefined']);
    }

    var chart = $('#containerCommunity').highcharts();
    chart.setTitle({text: "Top "+num+" Communities"});
    chart.xAxis[0].setCategories(labels);
    $.each(floodData,function(i,obj){
        chart.addSeries(obj);
    });

}

function calcNFIP(places){
    var data = {   name: 'NFIP Status',
        colorByPoint: true,
        data: []
        };
    var dataArray = {};
    $.each( places, function( i,place ){
        if(typeof(dataArray[place['NFIP_Status']]) == 'undefined'){
            dataArray[place['NFIP_Status']] = 1;
        }
        else{
            dataArray[place['NFIP_Status']] = dataArray[place['NFIP_Status']] + 1;
        }
    });
    $.each(dataArray,function(key,value){
        data.data.push({name:key,y:((value/places.length)*100)});
    });
    var chart = $('#containerNFIP').highcharts();
    chart.addSeries(data);
}




</script>

    <h4>DRAFT - Summary Stats from Alaska Flood Database - DRAFT</h4>

<div class = 'center'>
        <div id="loading-image" style="width:69px;height:89px;border:1px solid black;position:relative;top:10%;left:50%;padding:2px;border:10px"><img src='https://www.w3schools.com/jquery/demo_wait.gif' width="64" height="64" /><br>Loading..</div>

        <i><a href="https://docs.google.com/a/noaa.gov/spreadsheets/d/1b7cEPfb8wYtCUnx1JWsNRd29GCRzwzFeQCYngm-LnY4/edit?usp=sharing">Database</a></i><br>
        Search for River:<input type="text" id="riverSearch"><button type="button" onclick ="findStreamByName($('#riverSearch').val(),map);">Find Rivers</button><span id="foundRivers"></span><br>
        <div style="float:center;">Single Year:<input type="text" id="singleYear" maxlength="4" size="4">
        <label for="years2show">Years to Show:</label>
        <input type="text" id="years2show" readonly style="border:0;padding:4px; color:#f6931f; font-size: 14px; font-weight:bold;">
        <span id='numberPlotted'></span>
        <center><div id="qmeas-years"  style="width: 300px;"></div></center>
        <label for="months2show">Months to Show:</label>
         <input type="text" id="months2show" readonly style="border:0;padding:4px; color:#f6931f; font-size: 14px; font-weight:bold;">
        <center><div id="qmeas-months"  style="width: 300px;"></div><input type="checkbox" id="undefMonth" checked>Include Undefined Months</center>
        Show Only:<input type="checkbox" name="type[]" value="fedDR">FEMA DR
        <input type="checkbox" name="type[]" value="stateDR">State DR<br>
        <input type="checkbox" name="severity[]" value="Major" checked>Major
        <input type="checkbox" name="severity[]" value="Moderate" checked>Moderate
        <input type="checkbox" name="severity[]" value="Minor" checked>Minor
        <input type="checkbox" name="severity[]" value="Undefined" checked>Undefined<br>

        <input type="checkbox" class = 'cause' name="cause[]" value="rainfall" checked>Rainfall
        <input type="checkbox" class = 'cause' name="cause[]" value="ice jam" checked>Ice Jam
        <input type="checkbox" class = 'cause' name="cause[]" value="coastal" checked>Coastal
        <input type="checkbox" class = 'cause' name="cause[]" value="snowmelt" checked>Snowmelt
        <input type="checkbox" class = 'cause' name="cause[]" value="GDL" checked>Glacial-Dammed Lake
        <input type="checkbox" class = 'cause' name="cause[]" value="overflow" checked>Overflow
        <input type="checkbox" class = 'cause' name="cause[]" value="undefined" checked>Undefined
        <button type="button" id="uncheckCause" onclick ="$('.cause').prop('checked', false);mapFloods(geoFloods);">Uncheck All</button><br>

    </div>
    <div class="maincontainer">
        <div id="mapid"></div>
        <div class='dataTable buttonControl'></div>
        <table id="floodMapTable" class='box-table-a dataTable' ></table>
        <div id="siteInfo" class=' dataTable' ></div>

        <div id="containerCauses" ></div>
        <div class='dataTable buttonControl'></div>
        <table id="floodTable" class='box-table-a dataTable' ></table>
        <div id="containerSource" ></div>
        <div id="containerByDecade" ></div>

    </div>
    <div class="maincontainer">
        <div id="containerNFIP" ></div>
        <div id="containerBorough" ></div>
        <div id="containerCommunity" ></div>
        <div class='dataTable buttonControl'></div>
        <table id="floodCommunityTable" class='box-table-a dataTable' ></table>

    </div>
<script>


Highcharts.chart('containerNFIP', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie'
    },
    credits: {
        enabled: false
    },

    title: {
        text: 'NFIP Participation Summary'
    },
    tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                style: {
                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                }
            }
        }
    },
    series: null

});

Highcharts.chart('containerBorough', {
    chart: {
        type: 'column'
    },
    credits: {
        enabled: false
    },


    xAxis: {
        categories: ['1', '2', '3', '4', '5','6','7','8','9','10']
    },
    yAxis: {
        min: 0,
        title: {
            text: 'Documented Floods'
        },
        stackLabels: {
            enabled: true,
            style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
        }
    },
    legend: {
        align: 'right',
        x: -30,
        verticalAlign: 'top',
        y: 25,
        floating: true,
        backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
        borderColor: '#CCC',
        borderWidth: 1,
        shadow: false
    },
    tooltip: {
        headerFormat: '<b>{point.x}</b><br/>',
        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
    },
    plotOptions: {
        column: {
            stacking: 'normal',
            dataLabels: {
                enabled: true,
                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
            }
        }
    },
    series: null

});

Highcharts.chart('containerCommunity', {
    chart: {
        type: 'column'
    },
    credits: {
        enabled: false
    },

    yAxis: {
        min: 0,
        title: {
            text: 'Documented Floods'
        },
        stackLabels: {
            enabled: true,
            style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
        }
    },
    legend: {
        align: 'right',
        x: -30,
        verticalAlign: 'top',
        y: 25,
        floating: true,
        backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
        borderColor: '#CCC',
        borderWidth: 1,
        shadow: false
    },
    tooltip: {
        headerFormat: '<b>{point.x}</b><br/>',
        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
    },
    plotOptions: {
        column: {
            stacking: 'normal',
            dataLabels: {
                enabled: true,
                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
            },
            point:{
                 events: {
                    click: function (event) {
                        var severity = this.series.name;
                        var floodList = getFloodList(floods,severity,'name',this.category);
                        makeFloodTable('floodCommunityTable',floods,floodList);
                    }
                }
            }
        },
    },
    series: null

});

Highcharts.chart('containerSource', {
    chart: {
        type: 'column'
    },
    credits: {
        enabled: false
    },

    yAxis: {
        min: 0,
        title: {
            text: 'Documented Floods'
        },
        stackLabels: {
            enabled: true,
            style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
        }
    },
    legend: {
        align: 'right',
        x: -30,
        verticalAlign: 'top',
        y: 25,
        floating: true,
        backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
        borderColor: '#CCC',
        borderWidth: 1,
        shadow: false
    },
    tooltip: {
        headerFormat: '<b>{point.x}</b><br/>',
        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
    },
    plotOptions: {
        column: {
            stacking: 'normal',
            dataLabels: {
                enabled: true,
                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
            }
        }
    },
    series: null

});

Highcharts.chart('containerCauses', {
    chart: {
        type: 'column',
    },
    credits: {
        enabled: false
    },
    yAxis: {
        min: 0,
        title: {
            text: 'Documented Floods'
        },
        stackLabels: {
            enabled: true,
            style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
        }
    },
    legend: {
        align: 'right',
        x: -30,
        verticalAlign: 'top',
        y: 25,
        floating: true,
        backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
        borderColor: '#CCC',
        borderWidth: 1,
        shadow: false
    },
    tooltip: {
        headerFormat: '<b>{point.x}</b><br/>',
        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
    },
    plotOptions: {
        column: {
            stacking: 'normal',
            dataLabels: {
                enabled: true,
                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
            },
            point:{
                 events: {
                    click: function (event) {
                        var severity = this.series.name;
                        var floodList = getFloodList(floods,severity,'fldCause',this.category);
                        makeFloodTable('floodTable',floods,floodList);
                    }
                }
            }
        },
    },
    series: null

});

Highcharts.chart('containerByDecade', {
    chart: {
        type: 'column'
    },
    credits: {
        enabled: false
    },
    title: {
        text: 'Floods Documented By Decade'
    },
    yAxis: {
        min: 0,
        title: {
            text: 'Documented Floods by Decade'
        },
        stackLabels: {
            enabled: true,
            style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
        }
    },
    legend: {
        align: 'right',
        x: -30,
        verticalAlign: 'top',
        y: 25,
        floating: true,
        backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
        borderColor: '#CCC',
        borderWidth: 1,
        shadow: false
    },
    tooltip: {
        headerFormat: '<b>{point.x}</b><br/>',
        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
    },
    plotOptions: {
        column: {
            stacking: 'normal',
            dataLabels: {
                enabled: true,
                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
            }
        }
    },
    series: null

});


var nhdLargeFlow = L.tileLayer('https://services.nationalmap.gov/arcgis/services/nhd/MapServer/WMSServer?',{
    layers : '3',
    version : '1.3.0'
    });

var esriTopo = L.esri.basemapLayer("Topographic");
var usgsTopo =   L.esri.tiledMapLayer({
    url: "https://services.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer"
  });


var worldTerrain  =  L.tileLayer( "https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}" );
var oceanLayer    =  L.tileLayer( "https://txpub.usgs.gov/arcgis/rest/services/Mapping/Ocean/MapServer/tile/{z}/{y}/{x}",{"maxNativeZoom":11} );
var hydroTerrain  =  L.tileLayer( "https://txpub.usgs.gov/arcgis/rest/services/Mapping/HydroBaseMapForTerrain/MapServer/tile/{z}/{y}/{x}",{"maxNativeZoom":11} );
var hydroMask     =  L.tileLayer( "https://txpub.usgs.gov/arcgis/rest/services/Mapping/Mask/MapServer/tile/{z}/{y}/{x}", {"opacity":0.2,"maxNativeZoom":11} );
var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});

var hydroBase = L.layerGroup([worldTerrain, hydroTerrain, hydroMask]);

// create map with ESRI World Terrain Base, Streamer Ocean, Streamer HydroBaseMapForTerrain, and Streamer Mask layers
map = new L.Map( "mapid", {
    "minZoom" : 4,
   // "maxZoom" : 11,
    "layers"  : [Esri_WorldImagery,esriTopo,usgsTopo,hydroBase],
    "center"  : new L.LatLng(65,-150),
    "zoom"    : 4,
    "attributionControl" : false
});

var baseMaps = {
    "World Imagery" : Esri_WorldImagery,
    "Topography" : esriTopo,
    "USGS Maps" : usgsTopo,
    "Hydrography" : hydroBase,
};

var mapControl = L.control.layers(baseMaps,null).addTo(map);
L.control.coordinates(
    {labelTemplateLat:"Lat: {y}",
	labelTemplateLng:"Lon: {x}"}).addTo(map);
console.log('Built map');

$('.leaflet-container').css('cursor','crosshair');

map.on('click', function(e) {
        streamer(e.latlng.lat,e.latlng.lng);
    });

</script>

